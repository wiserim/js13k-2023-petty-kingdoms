function rand(e,t){return e+Math.floor(Math.random()*(t-e))}function distance(e,t,a,n){return Math.sqrt((e-a)**2+(t-n)**2)}function shuffle(e){return e.sort(((e,t)=>.5-Math.random()))}function el(e,t){return t?document.querySelectorAll(e):document.querySelector(e)}function c(e,t,a){a?e.classList.remove(t):e.classList.add(t)}function attr(e,t,a=null){return null!==a?e.setAttribute(t,a):e.getAttribute(t)}function txt(e,t){e.innerHTML=t}function on(e,t,a){e.addEventListener(t,a)}function toggleFullScreen(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.body.requestFullscreen()}function updateGameOptionsPlayerBtn(e){let t=(parseInt(attr(e,"data-player"))+1)%5;switch(attr(e,"data-player",t),t){case 0:txt(e,"Disabled");break;case 1:txt(e,"Player");break;case 2:txt(e,"CPU: easy");break;case 3:txt(e,"CPU: normal");break;case 4:txt(e,"CPU: hard")}}function updateGameOptionsMapBtn(e){let t=attr(e,"data-map-size")%3+1;switch(attr(e,"data-map-size",t),t){case 1:txt(e,"10 regions");break;case 2:txt(e,"16 regions");break;case 3:txt(e,"36 regions")}}function updatePlayerUi(){txt(playerName,activePlayer.name),txt(turnCount,turn),attr(playerShield,"fill",activePlayer.color),updateResourcesUi()}function updateResourcesUi(){txt(gold,activePlayer.gold),txt(goldIncome,activePlayer.income)}function updateRegionUi(){txt(regionName,activeRegion?activeRegion.name:""),txt(regionArmy,activeRegion?activeRegion.army:""),txt(regionActiveArmy,activeRegion?activeRegion.activeArmy:""),attr(regionBuyArmyInput,"max",activeRegion?activePlayer.gold:0),txt(regionSendArmyMax,activeRegion?activeRegion.activeArmy:0),attr(regionSendArmyInput,"max",activeRegion?activeRegion.activeArmy:0)}function enableSendArmy(){if(!(regionSendArmyInput.value<=0)){sendArmyFlag=1,attr(map,"data-send-army",1),c(regionSendArmyBtn,"d-none"),c(regionSendArmyCancelBtn,"d-none",1);for(let e of regions)(e===activeRegion||activeRegion.neighbours.has(e))&&attr(e.territory,"data-target",1)}}function disableSendArmy(){sendArmyFlag=0,attr(map,"data-send-army",0),c(regionSendArmyBtn,"d-none",1),c(regionSendArmyCancelBtn,"d-none");for(let e of regions)attr(e.territory,"data-target",0)}function openModal(e,t){t&&(e.querySelector(".modal-content").innerHTML=t),c(container,"disabled"),c(e,"open")}function closeModal(e){c(container,"disabled",1),c(e,"open",1)}function openBattleModal(e,t,a,n){txt(battleRegion,n.name),txt(attName,e.name),txt(attArmy,a),txt(defName,t?t.name:"Neutral"),txt(defArmy,n.army),txt(attAdvantage," "),txt(defAdvantage," "),txt(battleResult," "),openModal(battleModal)}function closeBattleModal(){closeModal(battleModal),checkWinCondition(),activePlayer.ai&&setTimeout((()=>{aiEnd()}),500)}class Region{constructor(e){let t=this;t._id,t.name="city "+e,t.territory=document.createElementNS("http://www.w3.org/2000/svg","path"),t.city=document.createElement("div"),t.player=null,t.color="transparent",t._army,t.army=5,t.blockedArmy=0,t.income=3,t.neighbours=new Set,t.borders=[],t.id=e,attr(t.territory,"class","region"),attr(t.territory,"fill","transparent"),c(t.city,"city"),on(t.territory,"click",(()=>sendArmyFlag?sendArmy(t):selectRegion(t)))}set id(e){this._id=e,attr(this.territory,"id","r"+e)}get id(){return this._id}get activeArmy(){return this.army-this.blockedArmy}set owner(e){let t=this;t.player&&(t.player.regions=t.player.regions.filter((e=>e!==t))),t.player=e,e&&e.regions.push(t),attr(t.territory,"fill",e?e.color:"transparent"),attr(t.territory,"data-player",e?e.id:0)}get owner(){return this.player}set army(e){this._army=e,txt(this.city,e)}get army(){return this._army}generate(){let e,t,a,n,r,i,o,l,d,c=this,y=10,m=10,s="",u="",g="",p="",f="",A="";c.borders=[];for(let e=0;e<mapSize.x;e++){let t=mapArray[e].indexOf(c.id),a=mapArray[e].lastIndexOf(c.id);-1!=t&&c.borders.push({x:e,y1:t,y2:a})}for(d of(o=r=c.borders[0].y1,l=i=c.borders[0].y2,c.borders)){e=10*d.x,t=e+10,a=10*d.y1,n=10*(d.y2+1),s="",o=Math.min(o,d.y1),l=Math.max(l,d.y2);let c=r-d.y1<0?1:-1;if(r-d.y1!=0){let t=r;for(;t!=d.y1;){let a=10*t;s+=`L${e+y},${a+m}L${e-1+y},${a+5*c+m}`,t+=c}}u+=`${s}L${e+y},${a+m}L${e+5+y},${a+1+m}L${t+y},${a+m}`,s="",c=i-d.y2<0?1:-1;let p=0;if(i-d.y2!=0){let t=i;for(;t!=d.y2&&p<10;){let a=10*t+(c>0?20:0);s=` L${e+y},${a+m}L${e-1+y},${a-5*c+m} `+s,t+=c,p++}}g=`L${t+y},${n+m}L${t-5+y},${n+1+m}L${e+y},${n+m}${s}`+g,r=d.y1,i=d.y2}d=c.borders[0],e=10*d.x;for(let t=0;t<=d.y2-d.y1;t++)a=10*(d.y2-t),p+=`L${e-1+y},${a+5+m}L${e+y},${a+m}`;d=c.borders.slice(-1)[0],t=10*d.x+10;for(let e=0;e<=d.y2-d.y1;e++)a=10*(d.y1+e),f+=`L${t+y},${a+m}L${t-1+y},${a+5+m}`;A=`M${10*c.borders[0].x+y},${10*c.borders[0].y1+m}`+u+f+g+p+"Z",attr(c.territory,"d",A),c.city.style.left=3.125*(c.borders[0].x+(c.borders.length-1)/2+1)+"%",c.city.style.top="calc(10px + "+3.125*(o+(l-o)/2+1)+"%)"}setNeighbours(){let e,t=this,a=t.borders[0];if(t.neighbours.clear(),a.x>0)for(a.y1>0&&t.neighbours.add(findRegion(mapArray[a.x-1][a.y1-1])),a.y2<mapArray[0].length-1&&t.neighbours.add(findRegion(mapArray[a.x-1][a.y2+1])),e=a.y1;e<=a.y2;e++)t.neighbours.add(findRegion(mapArray[a.x-1][e]));for(a of t.borders)a.y1>0&&t.neighbours.add(findRegion(mapArray[a.x][a.y1-1])),a.y2<mapArray[0].length-1&&t.neighbours.add(findRegion(mapArray[a.x][a.y2+1]));if(a.x<mapArray.length-1)for(a.y1>0&&t.neighbours.add(findRegion(mapArray[a.x+1][a.y1-1])),a.y2<mapArray[0].length-1&&t.neighbours.add(findRegion(mapArray[a.x+1][a.y2+1])),e=a.y1;e<=a.y2;e++)t.neighbours.add(findRegion(mapArray[a.x+1][e]))}append(){map.prepend(this.territory),mapContainer.append(this.city)}remove(){this.territory.remove(),this.city.remove()}}class Player{constructor(e,t,a){let n=this;n.id=e,n.name=t,n.color=a,n.gold=10,n.regions=[],n.active=1,n.ai=0}get income(){let e=0;for(let t of this.regions)e+=t.income;return e}}function aiStart(){if(pause||aiAttackTimeout)return;let e=activePlayer,t=shuffle(e.regions),a=1===e.ai?.75:1;c(sidePanel,"disabled");for(let n of t){let t=n.neighbours.values();selectRegion(n);for(let r of t){if(r.player===e)continue;if(r.army>=n.army){regionBuyArmyInput.value=Math.min(r.army-n.army+rand(1,5),Math.floor(e.gold*a)),recruit();continue}if(r.army>n.activeArmy||n.activeArmy<2)continue;let t=r.army-1;return 1==e.ai?t+=rand(0,4):t+=rand(2,6),t=Math.min(Math.max(1,t),n.activeArmy-1),r.player&&!r.player.ai?(regionSendArmyInput.value=t,void sendArmy(r)):void(aiAttackTimeout=setTimeout((()=>{n.blockedArmy+=t,aiAttack(r,t)}),500))}}aiEnd()}function aiEnd(){if(pause)return;let e=activePlayer,t=shuffle(e.regions);if(e.ai>1&&e.gold)for(let a of t){let t=a.neighbours.values();for(let a of t)if(a.player!==e)return regionBuyArmyInput.value=e.gold,recruit(),c(sidePanel,"disabled",1),void endTurn()}c(sidePanel,"disabled",1),endTurn()}function aiAttack(e,t){if(pause)return void(aiAttackTimeout=0);let a=e.army,n=e.player,r=rand(1,6),i=rand(1,6),o=calculateBattle(t,a,Math.max(r-i,0)/10,Math.max(i-r,0)/10);e.army=o.defArmy,activeRegion.army-=t,activeRegion.blockedArmy-=t,e.army<1&&o.attArmy>0?(e.owner=activePlayer,e.army=o.attArmy,e.blockedArmy=o.attArmy,n&&(n.active=n.regions.length?1:0,checkWinCondition())):(activeRegion.army+=o.attArmy,activeRegion.blockedArmy+=o.attArmy),updateRegionUi(),aiAttackTimeout=0,3==activePlayer.ai?aiStart():aiEnd()}function genetateMap(){let e=[],t=0,a=[];for(let e of regions)e.remove();regionsPool=regionsPool.concat(regions),regions.splice(0,regions.length),regionsPool.sort(((e,t)=>e.id>t.id)),mapArray=Array(mapSize.x);for(let e=0;e<mapArray.length;e++)mapArray[e]=new Array(mapSize.y);switch(parseInt(attr(gameOptionsMapBtn,"data-map-size"))){case 1:t=10,e=[{id:1,x:rand(1,4),y:rand(1,4)},{id:2,x:rand(25,28),y:rand(1,4)},{id:3,x:rand(1,4),y:rand(25,28)},{id:4,x:rand(25,28),y:rand(25,28)},{id:5,x:rand(1,4),y:rand(6,23)},{id:6,x:rand(6,23),y:rand(1,4)},{id:7,x:rand(25,28),y:rand(6,23)},{id:8,x:rand(6,23),y:rand(25,28)},{id:9,x:rand(6,23),y:rand(6,13)},{id:10,x:rand(6,23),y:rand(13,23)}];break;case 2:t=16,e=generateSeeds(t,[[1,4],[6,13],[16,23],[25,28]],[[0,0],[3,0],[0,3],[3,3]]);break;case 3:t=36,e=generateSeeds(t,[[1,4],[6,9],[11,14],[16,19],[21,24],[26,28]],[[0,0],[5,0],[0,5],[5,5]])}a=shuffle(regionNames);for(let e=0;e<t;e++){let t;t=regionsPool.length?regionsPool.shift():new Region(e+1),t.name=a[e],t.append(),regions.push(t)}for(let t=0;t<mapSize.x;t++)for(let a=0;a<mapSize.y;a++){let n=[];for(let r of e)n.push(distance(r.x,r.y,t,a));let r=e[n.indexOf(Math.min(...n))];mapArray[t][a]=r.id}}function generateSeeds(e,t,a){let n=[{id:1,x:rand(1,4),y:rand(1,4)},{id:2,x:rand(25,28),y:rand(1,4)},{id:3,x:rand(1,4),y:rand(25,28)},{id:4,x:rand(25,28),y:rand(25,28)}],r=[1,0];for(let i=5;i<=e;i++){if(a.some((e=>e[0]===r[0]&&e[1]===r[1]))){let e=(r[0]+1)%t.length,a=r[0]>t.length-2?r[1]+1:r[1];r=[e,a]}n.push({id:i,x:rand(t[r[0]][0],t[r[0]][1]),y:rand(t[r[1]][0],t[r[1]][1])});let e=(r[0]+1)%t.length,o=r[0]>t.length-2?r[1]+1:r[1];r=[e,o]}return n}function generateRegionNames(){let e=["Wheat","Barley","Bread","Cheese","Beet","Turnip","Bean","Cow","Sheep","Chicken","Apple","Pear","Cherry"],t=["","town","field","ford","shire","borough"," Castle"];for(let a of e)for(let e of t)regionNames.push(a+e)}function findRegion(e){return regions.find((t=>t.id===e))}function selectRegion(e){activePlayer.regions.includes(e)&&(activeRegion&&attr(activeRegion.territory,"class","region"),activeRegion=e,attr(activeRegion.territory,"class","region active"),regionBuyArmyInput.value=0,txt(regionBuyArmyAmount,0),regionSendArmyInput.value=0,txt(regionSendArmyAmount,0),attr(mapActiveRegion,"xlink:href","#r"+activeRegion.id),updateRegionUi())}function recruit(){if(!activePlayer||!activeRegion)return;let e=Math.min(regionBuyArmyInput.value,activePlayer.gold);activePlayer.gold-=e,activeRegion.army+=e,activeRegion.blockedArmy+=e,regionBuyArmyInput.value=0,txt(regionBuyArmyAmount,0),updateRegionUi(),updateResourcesUi()}function sendArmy(e){if(activeRegion===e)return void disableSendArmy();if(!activeRegion.neighbours.has(e))return;if(disableSendArmy(),!activePlayer||!activeRegion)return;let t=Math.min(regionSendArmyInput.value,activeRegion.activeArmy);activeRegion.army-=t,e.player===activeRegion.player?(e.army+=t,e.blockedArmy+=t):attack(e,t),regionSendArmyInput.value=0,txt(regionSendArmyAmount,0),updateRegionUi()}function attack(e,t){let a=e.army,n=e.player;openBattleModal(activePlayer,n,t,e);for(let r=1;r<5;r++)setTimeout((()=>{if(attFactor=rand(1,6),defFactor=rand(1,6),attr(attDice,"data-value",attFactor),attr(defDice,"data-value",defFactor),r>3){let r=Math.max(attFactor-defFactor,0),i=Math.max(defFactor-attFactor,0),o=calculateBattle(t,a,r/10,i/10);txt(attAdvantage,r>0?`<b>Advantage:</b> +${10*r}%`:"&nbsp;"),txt(defAdvantage,i>0?`<b>Advantage:</b> +${10*i}%`:"&nbsp;"),e.army=o.defArmy,t=o.attArmy,e.army<1&&t>0?(txt(battleResult,`${activePlayer.name} won!`),e.owner=activePlayer,e.army=t,e.blockedArmy=t,n&&(n.active=n.regions.length?1:0)):(txt(battleResult,`${n?n.name:"Neutral"} won!`),activeRegion.army+=t,activeRegion.blockedArmy+=t),updateRegionUi()}}),500+200*r)}function startGame(){c(menuScreen,"d-none"),c(gameScreen,"d-none",1),genetateMap();for(let e of regions)e.army=5,e.generate(),e.setNeighbours(),e.owner=null;for(let e=0,t=players.length;e<t;e++){let t=attr(gameOptionsPlayerBtns[e],"data-player");players[e].active=t>0,players[e].ai=t-1,players[e].gold=10,t>0&&(regions[e].owner=players[e],regions[e].army=10)}playerIndex=0,activePlayer=players[0],turn=1,pause=0,c(sidePanel,"disabled",1),attr(map,"data-player",activePlayer.id),updatePlayerUi(),updateRegionUi(),activePlayer.ai&&aiStart()}function endTurn(){do{if(playerIndex=playerIndex<players.length-1?++playerIndex:0,!playerIndex){turn++;for(let e of players)e.gold+=e.income;for(let e of regions)e.blockedArmy=0}}while(!players[playerIndex].active);activePlayer=players[playerIndex],activeRegion&&attr(activeRegion.territory,"class","region"),activeRegion=null,attr(map,"data-player",activePlayer.id),updatePlayerUi(),updateRegionUi(),activePlayer.ai&&players.filter((e=>e.active)).length>1&&aiStart()}function calculateBattle(e,t,a,n){let r=e+e*a,i=t+t*n;return{attArmy:r?Math.round(e*Math.max(r-i,0)/r):0,defArmy:i?Math.round(t*Math.max(i-r,0)/i):0}}function startPause(){pause=1}function endPause(){pause=0,activePlayer.ai&&players.filter((e=>e.active)).length>1&&aiStart()}function checkWinCondition(){let e=players.filter((e=>e.active));e.length>1||(openModal(infoModal,`<h3 class=t-center>${e[0].name} wins!</h3>`),closeInfoModalCallback=endGame)}function endGame(){c(menuScreen,"d-none",1),c(gameScreen,"d-none")}let mapArray,activePlayer,aiAttackTimeout,activeRegion,container=el("#container"),menuScreen=el("#menu-screen"),gameScreen=el("#game-screen"),mapContainer=el("#map-container"),startGameBtn=el("#start-game-btn"),gameOptionsPlayerBtns=[el("#go-p1-btn"),el("#go-p2-btn"),el("#go-p3-btn"),el("#go-p4-btn")],gameOptionsMapBtn=el("#go-map-btn"),map=el("#map"),mapActiveRegion=el("#map-active-region"),sidePanel=el("#side-panel"),turnCount=el("#turn"),endTurnBtn=el("#end-turn"),playerName=el("#player-name"),playerShield=el("#player-shield"),gold=el("#gold"),goldIncome=el("#gold-income"),regionName=el("#region-name"),regionArmy=el("#region-army"),regionActiveArmy=el("#region-army-active"),regionBuyArmyAmount=el("#region-buy-army-amount"),regionBuyArmyInput=el("#region-buy-army-input"),regionBuyArmyBtn=el("#region-buy-army-btn"),regionSendArmyAmount=el("#region-send-army-amount"),regionSendArmyMax=el("#region-send-army-max"),regionSendArmyInput=el("#region-send-army-input"),regionSendArmyBtn=el("#region-send-army-btn"),regionSendArmyCancelBtn=el("#region-send-army-cancel-btn"),fullscreenBtn=el("#toggle-fullscreen"),menuBtn=el("#toggle-menu"),menuModal=el("#menu-modal"),menuEndBtn=el("#menu-end-btn"),menuRestartBtn=el("#menu-restart-btn"),menuResumeBtn=el("#menu-resume-btn"),infoModal=el("#info-modal"),closeInfoModalBtn=el("#close-info-modal-btn"),closeInfoModalCallback=null,battleModal=el("#battle-modal"),battleRegion=el("#battle-region"),attName=el("#att-name"),attArmy=el("#att-army"),attDice=el("#att-dice"),attAdvantage=el("#att-advantage"),defName=el("#def-name"),defArmy=el("#def-army"),defDice=el("#def-dice"),defAdvantage=el("#def-advantage"),battleResult=el("#battle-result"),battleModalCloseBtn=el("#battle-modal-close-btn"),mapSize={x:30,y:30},regions=[],regionsPool=[],regionNames=[],players=[new Player(1,"Red Kingdom","#AA0000"),new Player(2,"Green Kingdom","#00AA00"),new Player(3,"Blue Kingdom","#0000AA"),new Player(4,"Yellow Kingdom","#FFFF00")],playerIndex=0,turn=1,pause=0,sendArmyFlag=0;function init(){on(fullscreenBtn,"click",toggleFullScreen),on(startGameBtn,"click",(()=>{gameOptionsPlayerBtns.filter((e=>attr(e,"data-player")>0)).length>1?startGame():openModal(infoModal,"<h3 class=t-center>Select 2 or more players.</h3>")}));for(let e of gameOptionsPlayerBtns)on(e,"click",(()=>updateGameOptionsPlayerBtn(e)));on(gameOptionsMapBtn,"click",(()=>updateGameOptionsMapBtn(gameOptionsMapBtn))),on(regionBuyArmyInput,"input",(e=>txt(regionBuyArmyAmount,e.target.value))),on(regionBuyArmyBtn,"click",recruit),on(regionSendArmyInput,"input",(e=>txt(regionSendArmyAmount,e.target.value))),on(regionSendArmyBtn,"click",enableSendArmy),on(regionSendArmyCancelBtn,"click",disableSendArmy),on(endTurnBtn,"click",endTurn),on(closeInfoModalBtn,"click",(()=>{closeModal(infoModal),closeInfoModalCallback&&closeInfoModalCallback(),closeInfoModalCallback=null})),on(battleModalCloseBtn,"click",closeBattleModal),on(menuBtn,"click",(()=>{openModal(menuModal),startPause()})),on(menuEndBtn,"click",(()=>{closeModal(menuModal),endGame()})),on(menuRestartBtn,"click",(()=>{closeModal(menuModal),startGame()})),on(menuResumeBtn,"click",(()=>{closeModal(menuModal),endPause()})),generateRegionNames()}init();